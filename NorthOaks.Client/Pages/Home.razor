@page "/home"
@using NorthOaks.Shared.Model.Contracts
@using System.Linq
@using System.Text.Json
@inject HttpClient Http
@inject IJSRuntime JS
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Routing
@attribute [Authorize]

<!-- NOTE: px-4 removed, no-pad added -->
<div class="container-fluid mt-4 mb-4 page-with-sidebar no-pad">
    <div class="page-grid">
        <!-- Sidebar -->
        <aside class="app-sidebar">
            <div class="sb-brand">
                <span class="sb-logo">🦁</span>
                <span class="sb-title">ContractHub</span>
            </div>

            <nav class="sb-nav">
                <NavLink href="/home" class="sb-link" Match="NavLinkMatch.All">
                    <i class="bi bi-collection"></i><span>Library</span>
                </NavLink>
                <NavLink href="/upload" class="sb-link" Match="NavLinkMatch.Prefix">
                    <i class="bi bi-upload"></i><span>Upload</span>
                </NavLink>
                <NavLink href="/settings" class="sb-link" Match="NavLinkMatch.Prefix">
                    <i class="bi bi-gear"></i><span>Settings</span>
                </NavLink>
            </nav>

            <!-- SORT + PIN + PAGE SIZE -->
            <div class="sb-panel">
                <div class="sb-sec-title">Sort</div>

                <!-- Pin switches (grouped for spacing) -->
                <div class="pin-group">
                    <label class="sb-switch">
                        <input type="checkbox" @bind="pinFirst" />
                        <span>Pinned first</span>
                    </label>
                    <label class="sb-switch">
                        <input type="checkbox" @bind="pinOnly" @bind:after="OnPinOnlyChanged" />
                        <span>Pinned only</span>
                    </label>
                </div>

                <div class="sb-radios mt-1">
                    <label class="sb-radio">
                        <input type="radio" name="sort" value="uploaded_desc"
                               checked="@("uploaded_desc" == sortKey)"
                               @onchange="OnSortChanged" />
                        <span>Newest</span>
                    </label>
                    <label class="sb-radio">
                        <input type="radio" name="sort" value="uploaded_asc"
                               checked="@("uploaded_asc" == sortKey)"
                               @onchange="OnSortChanged" />
                        <span>Oldest</span>
                    </label>
                    <label class="sb-radio">
                        <input type="radio" name="sort" value="name_asc"
                               checked="@("name_asc" == sortKey)"
                               @onchange="OnSortChanged" />
                        <span>A–Z</span>
                    </label>
                    <label class="sb-radio">
                        <input type="radio" name="sort" value="name_desc"
                               checked="@("name_desc" == sortKey)"
                               @onchange="OnSortChanged" />
                        <span>Z–A</span>
                    </label>
                    <label class="sb-radio">
                        <input type="radio" name="sort" value="uploader_asc"
                               checked="@("uploader_asc" == sortKey)"
                               @onchange="OnSortChanged" />
                        <span>Uploader A–Z</span>
                    </label>
                    <label class="sb-radio">
                        <input type="radio" name="sort" value="uploader_desc"
                               checked="@("uploader_desc" == sortKey)"
                               @onchange="OnSortChanged" />
                        <span>Uploader Z–A</span>
                    </label>
                </div>

                <hr class="sb-hr" />

                <div class="sb-sec-title">Results per page</div>
                <select class="sb-select"
                        @bind="pageSize"
                        @bind:after="OnPageSizeChanged">
                    <option value="6">6</option>
                    <option value="9">9</option>
                    <option value="12">12</option>
                    <option value="24">24</option>
                </select>

                <button class="btn sb-reset mt-2" @onclick="ResetSidebar">Reset</button>
            </div>

            <div class="sb-footer">
                <a class="sb-mini" href="/help"><i class="bi bi-question-circle"></i></a>
                <a class="sb-mini" href="/profile"><i class="bi bi-person"></i></a>
            </div>
        </aside>

        <!-- Main -->
        <main class="page-main">
            <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap library-header">
                <h4 class="fw-semibold mb-2 mb-md-0 library-title">Contract Library</h4>

                <div class="d-flex align-items-center gap-3">
                    <div class="position-relative">
                        <i class="bi bi-search position-absolute top-50 start-0 translate-middle-y ms-3 search-icon"></i>
                        <input class="form-control ps-5 search-pill search-xl"
                               placeholder="Search contracts..."
                               @bind="searchTerm" @bind:after="() => currentPage = 1" />
                    </div>

                    <!-- View toggle in header -->
                    <div class="btn-group view-toggle" role="group" aria-label="View mode">
                        <button type="button" class="btn @(isGridView ? "active" : null)" @onclick="() => toggleView(true)" title="Grid view">
                            <i class="bi bi-grid"></i>
                        </button>
                        <button type="button" class="btn @(!isGridView ? "active" : null)" @onclick="() => toggleView(false)" title="List view">
                            <i class="bi bi-list"></i>
                        </button>
                    </div>
                </div>
            </div>

            @if (isLoading)
            {
                <p>Loading contracts…</p>
            }
            else if (!string.IsNullOrEmpty(error))
            {
                <div class="alert alert-danger">@error</div>
            }
            else
            {
                // filter by search
                var filtered = contracts
                .Where(c => string.IsNullOrEmpty(searchTerm)
                || CleanFileName(c.FileName).Contains(searchTerm, StringComparison.OrdinalIgnoreCase)
                || (c.UploadedBy ?? "").Contains(searchTerm, StringComparison.OrdinalIgnoreCase))
                .ToList();

                // filter pinned-only if requested
                if (pinOnly)
                    filtered = filtered.Where(c => IsPinned(c.Id)).ToList();

                // secondary key for normal sort
                Func<ContractReadDto, object> key = sortKey switch
                {
                    "uploaded_asc" => c => c.UploadDate,
                    "name_asc" => c => CleanFileName(c.FileName),
                    "name_desc" => c => CleanFileName(c.FileName),
                    "uploader_asc" => c => c.UploadedBy ?? string.Empty,
                    "uploader_desc" => c => c.UploadedBy ?? string.Empty,
                    _ => c => c.UploadDate
                };
                bool asc = sortKey is "uploaded_asc" or "name_asc" or "uploader_asc";

                IEnumerable<ContractReadDto> q = filtered;

                // if pinFirst: primary sort = pinned desc, then chosen key
                if (pinFirst)
                {
                    var ordered = q.OrderByDescending(c => IsPinned(c.Id));
                    q = asc ? ordered.ThenBy(key) : ordered.ThenByDescending(key);
                }
                else
                {
                    q = asc ? q.OrderBy(key) : q.OrderByDescending(key);
                }

                filtered = q.ToList();

                var totalPages = (int)Math.Ceiling(filtered.Count / (double)pageSize);
                var page = filtered.Skip((currentPage - 1) * pageSize).Take(pageSize).ToList();

                <p class="results-hint">@filtered.Count contracts found</p>

                @if (isGridView)
                {
                    <div class="row g-4 home-grid">
                        @foreach (var c in page)
                        {
                            <div class="col-xxl-4 col-xl-4 col-lg-6">
                                <div class="contract-card contract-hover position-relative home-card">
                                    <ContractCard Id="@c.Id"
                                                  FileName="@CleanFileName(c.FileName)"
                                                  UploadedBy="@(c.UploadedBy ?? "Unknown")"
                                                  UploadDate="@c.UploadDate"
                                                  UserId="@c.UserId"
                                                  IsPublic="@c.IsPublic"
                                                  OnDelete="DeleteContract"
                                                  IsPinned="IsPinned(c.Id)"
                                                  OnTogglePin="() => TogglePin(c.Id)" />
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="list-group">
                        @foreach (var c in page)
                        {
                            <div class="contract-row mb-2 position-relative">
                                <ContractList Id="@c.Id"
                                              FileName="@CleanFileName(c.FileName)"
                                              UploadDate="@c.UploadDate"
                                              UploadedBy="@c.UploadedBy"
                                              OnDelete="DeleteContract" />
                                <!-- If you also want pins in list rows, create a list component variant with the pin control -->
                            </div>
                        }
                    </div>
                }

                @if (totalPages > 1)
                {
                    <nav class="mt-3" aria-label="Contracts pagination">
                        <ul class="pagination justify-content-center">
                            <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                                <button class="page-link" @onclick="() => ChangePage(currentPage - 1)" disabled="@(currentPage == 1)">Previous</button>
                            </li>

                            @for (int i = 1; i <= totalPages; i++)
                            {
                                var n = i;
                                <li class="page-item @(currentPage == n ? "active" : "")">
                                    <button class="page-link" @onclick="() => ChangePage(n)" disabled="@(currentPage == n)">@n</button>
                                </li>
                            }

                            <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                                <button class="page-link" @onclick="() => ChangePage(currentPage + 1)" disabled="@(currentPage == totalPages)">Next</button>
                            </li>
                        </ul>
                    </nav>
                }
            }

            @if (showDeleteModal)
            {
                <div class="modal-backdrop fade show"></div>

                <div class="modal fade show d-block" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">

                            <div class="modal-header">
                                <h5 class="modal-title text-danger">Delete Contract?</h5>
                                <button type="button" class="btn-close" @onclick="CancelDelete"></button>
                            </div>

                            <div class="modal-body">
                                <p>Are you sure you want to permanently delete this file?</p>
                            </div>

                            <div class="modal-footer">
                                <button class="btn btn-secondary" @onclick="CancelDelete">Cancel</button>
                                <button class="btn btn-danger" @onclick="ConfirmDelete">Delete</button>
                            </div>

                        </div>
                    </div>
                </div>
            }

        </main>
    </div>
</div>

@code {
    [Inject] protected ToastService ToastService { get; set; } = default!;
    private List<ContractReadDto> contracts = new();
    private bool isLoading = true;
    private string? error;
    private bool isGridView = true;
    private string searchTerm = "";
    private int currentPage = 1;
    private int pageSize = 9;

    private string sortKey = "uploaded_desc";
    private HashSet<int> pinned = new();
    private bool pinFirst = false;
    private bool pinOnly = false;

    private bool showDeleteModal = false;
    private int pendingDeleteId;


    const string PinStorageKey = "pinnedContracts";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            contracts = await Http.GetFromJsonAsync<List<ContractReadDto>>("/api/contracts") ?? new();
            await LoadPinsAsync();
        }
        catch (HttpRequestException ex)
        {
            if (ex.StatusCode == System.Net.HttpStatusCode.Unauthorized)
                error = "Session expired. Please log in again.";
            else
                error = $"Failed to load contracts: {ex.Message}";
        }
        finally { isLoading = false; }
    }

    private async Task LoadPinsAsync()
    {
        try
        {
            var json = await JS.InvokeAsync<string>("localStorage.getItem", PinStorageKey);
            if (!string.IsNullOrWhiteSpace(json))
            {
                var ids = JsonSerializer.Deserialize<HashSet<int>>(json);
                pinned = ids ?? new HashSet<int>();
            }
        }
        catch { pinned = new(); }
    }

    private async Task SavePinsAsync()
    {
        try
        {
            var json = JsonSerializer.Serialize(pinned);
            await JS.InvokeVoidAsync("localStorage.setItem", PinStorageKey, json);
        }
        catch { }
    }

    private bool IsPinned(int id) => pinned.Contains(id);

    private async Task TogglePin(int id)
    {
        if (!pinned.Add(id)) pinned.Remove(id);
        await SavePinsAsync();
        StateHasChanged();
    }

    private async Task DeleteContract(int id)
    {
        pendingDeleteId = id;
        showDeleteModal = true;
        await JS.InvokeVoidAsync("modalHelper.open");
    }

    private async Task ConfirmDelete()
    {
        var res = await Http.DeleteAsync($"/api/contracts/{pendingDeleteId}");
        if (res.IsSuccessStatusCode)
        {
            contracts.RemoveAll(c => c.Id == pendingDeleteId);
            pinned.Remove(pendingDeleteId);
            await SavePinsAsync();
            ToastService.Notify(new(ToastType.Success, "Contract Deleted Successfully"));
        }
        else
        {
            ToastService.Notify(new(ToastType.Danger, "Failed to delete contract"));
        }

        showDeleteModal = false;
        StateHasChanged();
    }

    private void CancelDelete()
    {
        showDeleteModal = false;
        pendingDeleteId = 0;
        JS.InvokeVoidAsync("modalHelper.close");

    }


    private void toggleView(bool grid) => isGridView = grid;

    private string CleanFileName(string s)
    {
        var i = s.IndexOf('_');
        return (i >= 0 && i < s.Length - 1) ? s[(i + 1)..] : s;
    }

    private void ChangePage(int page)
    {
        var totalFiltered = contracts.Where(c => string.IsNullOrEmpty(searchTerm)
                              || CleanFileName(c.FileName).Contains(searchTerm, StringComparison.OrdinalIgnoreCase)
                              || (c.UploadedBy ?? "").Contains(searchTerm, StringComparison.OrdinalIgnoreCase))
                     .Count();

        var totalPages = (int)Math.Ceiling(totalFiltered / (double)pageSize);

        if (page >= 1 && page <= totalPages && page != currentPage)
        {
            currentPage = page;
            StateHasChanged();
        }
    }

    private void OnSortChanged(ChangeEventArgs e)
    {
        sortKey = e?.Value?.ToString() ?? "uploaded_desc";
        currentPage = 1;
        StateHasChanged();
    }

    private void OnPageSizeChanged()
    {
        currentPage = 1;
        StateHasChanged();
    }

    private void OnPinOnlyChanged()
    {
        if (pinOnly) pinFirst = true;
        currentPage = 1;
        StateHasChanged();
    }

    private void ResetSidebar()
    {
        sortKey = "uploaded_desc";
        pageSize = 9;
        pinFirst = false;
        pinOnly = false;
        currentPage = 1;
        StateHasChanged();
    }
}
