@using Microsoft.AspNetCore.Components.Authorization
@inject HttpClient Http
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JSRuntime
@using NorthOaks.Shared.Models
@inject NavigationManager Navigation
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.SignalR.Client
@implements IAsyncDisposable

@if (IsOpen)
{
    <form autocomplete="off">
        <div class="modal-backdrop fade show"></div>
        <div class="modal fade show d-block" tabindex="-1" style="z-index:1055;">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content" style="border-radius:14px;" autocomplete="off">
                    <div class="modal-header">
                        <h5 class="modal-title">Upload PDF Documents</h5>
                        <button type="button" class="btn-close" @onclick="HandleClose"></button>
                    </div>

                    <div class="modal-body">
                        <div class="d-flex justify-content-center">
                            <div class="card shadow p-4" style="max-width: 700px; width: 100%;" autocomplete="off">

                                <div class="card-body">

                                    <!-- Drag & Drop Area -->
                                    <div id="dropArea" class="border border-dashed rounded p-4 mb-3 text-center">
                                        <p class="mb-2">@dragText</p>
                                        <p>or click below to select a file</p>
                                    </div>

                                    <!-- Hidden InputFile -->
                                    <InputFile id="hiddenInputFile" style="display:none" autocomplete="off" form="noform"
                                               OnChange="HandleFileSelected" accept="application/pdf" />

                                    <button type="button" formnovalidate autocomplete="off" class="btn btn-primary w-100 mb-3" @onclick="UploadFile" disabled="@(!isFileSelected)">
                                        <i class="bi bi-upload"></i> Upload PDF
                                    </button>

                                    @if (!string.IsNullOrEmpty(statusMessage))
                                    {
                                        <div class="alert alert-info">@statusMessage</div>
                                    }

                                    @if (isUploading && uploadProgress > 0 && uploadProgress < 100)
                                    {
                                        <Progress Class="mt-3 mb-3">
                                            <ProgressBar Type="ProgressType.StripedAndAnimated"
                                                         Color="ProgressColor.Success"
                                                         Width="@uploadProgress">
                                                @uploadProgress%
                                            </ProgressBar>
                                        </Progress>
                                    }
                                    @if (isProcessing)
                                    {
                                        <Progress Class="mt-3 mb-3">
                                            <ProgressBar Type="ProgressType.StripedAndAnimated"
                                                         Color="ProgressColor.Primary"
                                                         Width="@uploadProgress">
                                            </ProgressBar>
                                        </Progress>
                                        <p class="text-center mt-2"><strong>@uploadProgress%</strong> - @processingMessage</p>
                                    }

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
}


@code {
    private bool _isOpen;
    [Parameter]
    public bool IsOpen
    {
        get => _isOpen;
        set
        {
            var wasClosed = !_isOpen && value;
            _isOpen = value;

            if (wasClosed)
            {
                _ = InitializeDragDrop();
            }
        }
    }
    [Parameter] public EventCallback OnClose { get; set; }
    [Inject] protected ToastService ToastService { get; set; } = default!;
    private IBrowserFile? selectedFile;
    private bool isFileSelected = false;
    private string statusMessage = string.Empty;
    private List<string> uploadedDocuments = new();
    private string userId;
    private bool isDragOver = false;
    private string dragText = "Drag & drop a PDF here";
    private int uploadProgress = 0;
    private bool isProcessing = false;
    private bool isUploading = false;
    private string processingMessage = "";
    private HubConnection? hubConnection;

    // Getting the User Info
    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user.Identity?.IsAuthenticated ?? false)
        {
            userId = user.FindFirst("uid").Value;
        }

        hubConnection = new HubConnectionBuilder()
        .WithUrl(Navigation.ToAbsoluteUri("/processingHub"))
        .WithAutomaticReconnect()
        .Build();

        // FIX: Mark lambda as async so 'await' can be used inside
        hubConnection.On<object>("ProcessingUpdate", async (payload) =>
        {
            var progress = (int)payload.GetType().GetProperty("progress").GetValue(payload);
            var message = (string)payload.GetType().GetProperty("message").GetValue(payload);

            uploadProgress = progress;
            processingMessage = message;

            if (progress == 100)
            {
                isProcessing = false;
                await HandleClose();
            }

            await InvokeAsync(StateHasChanged);
        });
        await hubConnection.StartAsync();
    }

    private void HandleFileSelected(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        isFileSelected = selectedFile != null && selectedFile.ContentType == "application/pdf";
        statusMessage = isFileSelected ? $"Selected: {selectedFile.Name}" : " Please select a PDF file.";
    }

    private async Task UploadFile()
    {
        isUploading = true;
        isProcessing = false;
        uploadProgress = 0;
        statusMessage = "Uploading...";

        if (selectedFile is not null)
        {
            try
            {
                using var stream = selectedFile.OpenReadStream(20 * 1024 * 1024);
                var content = new MultipartFormDataContent();

                var progressContent = new ProgressStreamContent(stream, 81920, (sent, total) =>
                {
                    uploadProgress = (int)((sent / (double)total) * 100);
                    InvokeAsync(StateHasChanged);
                });

                progressContent.Headers.ContentType =
                    new System.Net.Http.Headers.MediaTypeHeaderValue("application/pdf");

                content.Add(progressContent, "File", selectedFile.Name);
                content.Add(new StringContent(userId), "UserId");

                var response = await Http.PostAsync("api/Contracts/upload", content);

                isUploading = false;

                if (response.IsSuccessStatusCode)
                {

                    var uploadedContract = await response.Content.ReadFromJsonAsync<ContractStatus>();


                    if (uploadedContract != null && hubConnection?.State == HubConnectionState.Connected)
                    {
                        await hubConnection.SendAsync("JoinContractProcessing", uploadedContract.Id);
                    }

                    isProcessing = true;
                    uploadProgress = 0;
                    statusMessage = "Upload complete, processing...";
                    uploadedDocuments.Add(selectedFile.Name);

                    ToastService.Notify(new(ToastType.Success, $"Upload Successful"));
                }
                else
                {
                    isProcessing = false;
                    statusMessage = "Upload failed. Try again.";
                    ToastService.Notify(new(ToastType.Danger, $"Upload Failed"));
                }
            }
            catch (Exception ex)
            {
                isUploading = false;
                isProcessing = false;
                statusMessage = $"Error: {ex.Message}";
                ToastService.Notify(new(ToastType.Danger, $"Upload Failed"));
            }
        }
    }

    private async Task InitializeDragDrop()
    {
        await Task.Delay(50);
        await JSRuntime.InvokeVoidAsync("initDragDrop");
    }


    public async ValueTask DisposeAsync()
    {
        if (hubConnection is not null)
        {
            await hubConnection.DisposeAsync();
        }
    }

    private async Task HandleClose()
    {
        if (OnClose.HasDelegate)
        {
            await OnClose.InvokeAsync();
        }
    }

}