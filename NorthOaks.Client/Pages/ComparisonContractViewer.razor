@page "/compare-chat/{sessionId:int}"
@using NorthOaks.Shared.Model.Contracts
@using NorthOaks.Shared.Model.Chat
@using NorthOaks.Client.Components
@using System.Net.Http.Json
@using System.Linq
@inject HttpClient Http
@inject IJSRuntime JS
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]

<div class="contract-viewer-page">
    <div class="content">
        <div class="viewer-wrapper">
            <div class="contracts-sidebar" id="contractsSidebar" style="width: 280px; border-right: 1px solid #ddd; background: #f8f9fa; flex-shrink: 0;">
                <div style="padding: 16px; border-bottom: 1px solid #ddd;">
                    <h6 style="margin: 0 0 4px 0; color: var(--brand-blue); font-weight: 700;">
                        <i class="bi bi-files"></i>
                        @GetComparisonTitle()
                    </h6>
                    <small class="text-muted">
                        of @contracts.Count document@(contracts.Count == 1 ? "" : "s") selected
                    </small>
                </div>

                @if (contracts.Count == 0)
                {
                    <div class="text-center text-muted p-4">
                        <i class="bi bi-files" style="font-size: 2rem;"></i>
                        <p class="mt-2">Loading contracts...</p>
                    </div>
                }
                else
                {
                    <div class="list-group list-group-flush">
                        @foreach (var contract in contracts)
                        {
                            var isLeft = contract.Id == leftContract?.Id;
                            var isRight = contract.Id == rightContract?.Id;

                            <div class="list-group-item d-flex align-items-center gap-3">
                                <div class="text-start flex-grow-1">
                                    <div class="d-flex align-items-center gap-2">
                                        @if (isLeft)
                                        {
                                            <span class="badge" style="background: #007bff; font-size: 0.7rem; padding: 2px 8px;">LEFT</span>
                                        }
                                        @if (isRight)
                                        {
                                            <span class="badge" style="background: #28a745; font-size: 0.7rem; padding: 2px 8px;">RIGHT</span>
                                        }
                                        <div class="fw-semibold">@CleanFileName(contract.FileName)</div>
                                    </div>
                                    <small class="text-muted">@contract.UploadDate.ToShortDateString()</small>
                                </div>
                            </div>
                        }
                    </div>

                    <div class="m-3 p-3 rounded" style="background:#eef5ff; border:1px solid #d4e1ff;">
                        <div class="d-flex align-items-center mb-1">
                            <i class="bi bi-activity me-2" style="color:#003768;"></i>
                            <strong class="text-muted" style="font-size:0.8rem; text-transform:uppercase; letter-spacing:.06em;">
                                Comparison summary
                            </strong>
                        </div>
                        <small class="text-muted d-block">
                            Use the chat on the right to review key differences, clarify clauses, and capture guidance for this comparison.
                        </small>
                    </div>
                }
            </div>

            <div class="sidebar-resizer" @onmousedown="StartSidebarResize"></div>

            <div class="pdf-area" style="display: flex; flex-direction: row; gap: 0; height: 100%;">
                <div class="pdf-viewer-container" style="flex: 1; border-right: 1px solid #ddd; display: flex; flex-direction: column; height: 100%;">
                    @if (leftContract == null)
                    {
                        <div class="text-center text-muted m-4">
                            <i class="bi bi-file-earmark" style="font-size: 3rem;"></i>
                            <p class="mt-3">Left contract loading...</p>
                        </div>
                    }
                    else
                    {
                        <div class="pdf-viewer-header" style="padding: 8px 12px; background: #f8f9fa; border-bottom: 1px solid #ddd; word-wrap: break-word;">
                            <small class="text-muted" style="font-weight: 600;">@CleanFileName(leftContract.FileName)</small>
                        </div>
                        <PdfJsViewer Class="pdf-frame"
                                     ViewerId="leftPdfViewer"
                                     Url="@leftContract.FileUrl" />
                    }
                </div>

                <div class="pdf-viewer-container" style="flex: 1; display: flex; flex-direction: column; height: 100%;">
                    @if (rightContract == null)
                    {
                        <div class="text-center text-muted m-4">
                            <i class="bi bi-file-earmark" style="font-size: 3rem;"></i>
                            <p class="mt-3">Right contract loading...</p>
                        </div>
                    }
                    else
                    {
                        <div class="pdf-viewer-header" style="padding: 8px 12px; background: #f8f9fa; border-bottom: 1px solid #ddd; word-wrap: break-word;">
                            <small class="text-muted" style="font-weight: 600;">@CleanFileName(rightContract.FileName)</small>
                        </div>
                        <PdfJsViewer Class="pdf-frame"
                                     ViewerId="rightPdfViewer"
                                     Url="@rightContract.FileUrl" />
                    }
                </div>
            </div>

            <div class="resizer" @onmousedown="StartResize"></div>

            <div id="chatPanel" class="chat-panel">
                <div class="chat-header">
                    <div class="d-flex flex-column">
                        <div class="d-flex align-items-center gap-2 mb-1">
                            <span class="badge bg-primary">COMPARISON</span>
                            <small class="text-muted">
                                @contracts.Count document@(contracts.Count == 1 ? "" : "s")
                            </small>
                        </div>
                    </div>

                    <small class="text-muted d-block mt-2">
                        Ask questions to compare clauses, terms, and risk between these documents.
                    </small>
                </div>

                <div id="chatMessages" class="chat-messages">
                    @if (messages.Count == 0)
                    {
                        <div class="text-muted empty-chat">Start by asking what differs between the documents.</div>
                    }
                    else
                    {
                        @foreach (var msg in messages)
                        {
                            <div class="message @(msg.IsUser ? "user-message" : "ai-message")">
                                <strong>@(msg.IsUser ? "You" : "AI"):</strong>
                                <div class="message-content">
                                    @msg.Text

                                    @if (!msg.IsUser && msg.Sources != null && msg.Sources.Count > 0)
                                    {
                                        var relevantSources = msg.Sources
                                        .Where(s => s.SimilarityScore >= SIMILARITY_THRESHOLD)
                                        .OrderByDescending(s => s.SimilarityScore)
                                        .ToList();

                                        var leftSources = relevantSources
                                        .Where(s => s.ContractId == leftContract?.Id)
                                        .Take(3)
                                        .ToList();

                                        var rightSources = relevantSources
                                        .Where(s => s.ContractId == rightContract?.Id)
                                        .Take(3)
                                        .ToList();

                                        @if (leftSources.Count > 0 || rightSources.Count > 0)
                                        {
                                            <div class="source-links-inline">
                                                @if (leftSources.Count > 0)
                                                {
                                                    <span class="source-label" style="color: #007bff;">Left:</span>
                                                    @for (int i = 0; i < leftSources.Count; i++)
                                                    {
                                                        var source = leftSources[i];
                                                        var sourceIndex = msg.Sources.IndexOf(source);
                                                        <a class="source-link" @onclick="() => JumpToComparisonSource(msg.Sources, sourceIndex)">
                                                            @(i + 1) (Page @source.PageNumber)@(i < leftSources.Count - 1 ? "," : "")
                                                        </a>
                                                    }
                                                }

                                                @if (rightSources.Count > 0)
                                                {
                                                    <span class="source-label" style="color: #28a745; margin-left: 12px;">Right:</span>
                                                    @for (int i = 0; i < rightSources.Count; i++)
                                                    {
                                                        var source = rightSources[i];
                                                        var sourceIndex = msg.Sources.IndexOf(source);
                                                        <a class="source-link" @onclick="() => JumpToComparisonSource(msg.Sources, sourceIndex)">
                                                            @(leftSources.Count + i + 1) (Page @source.PageNumber)@(i < rightSources.Count - 1 ? "," : "")
                                                        </a>
                                                    }
                                                }
                                            </div>
                                        }
                                    }
                                </div>
                            </div>
                        }
                    }

                    @if (isLoading)
                    {
                        <div class="message loading-message">
                            <div class="loading-indicator">
                                <div class="loading-dots">
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                </div>
                            </div>
                        </div>
                    }
                </div>

                <div class="chat-input">
                    <div class="input-wrapper">
                        <textarea class="chat-input-field"
                                  value="@newMessage"
                                  @oninput="OnInput"
                                  placeholder="Ask about differences between contracts..."
                                  @onkeydown="OnKeyDown"
                                  rows="1"></textarea>

                        <button class="send-btn-inside"
                                @onclick="SendMessage"
                                @onclick:preventDefault="true"
                                disabled="@(string.IsNullOrWhiteSpace(newMessage) || isLoading)">
                            <svg width="16" height="16" viewBox="0 0 24 24"
                                 fill="none" stroke="currentColor"
                                 stroke-width="2" stroke-linecap="round"
                                 stroke-linejoin="round">
                                <line x1="22" y1="2" x2="11" y2="13" />
                                <polygon points="22,2 15,22 11,13 2,9" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public int sessionId { get; set; }

    [Inject] protected ToastService ToastService { get; set; } = default!;

    private List<ContractReadDto> contracts = new();
    private List<Message> messages = new();
    private string newMessage = "";
    private bool isLoading = false;
    private ContractReadDto? leftContract = null;
    private ContractReadDto? rightContract = null;

    private const double SIMILARITY_THRESHOLD = 0.20;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var session = await Http.GetFromJsonAsync<ChatSessionDto>($"/api/chatsessions/{sessionId}");

            if (session != null && session.ContractIds != null)
            {
                foreach (var contractId in session.ContractIds)
                {
                    var contract = await Http.GetFromJsonAsync<ContractReadDto>($"/api/contracts/comparison/{sessionId}/contract/{contractId}");
                    if (contract != null)
                    {
                        contracts.Add(contract);
                    }
                }
                if (contracts.Count >= 2)
                {
                    rightContract  = contracts[0];
                    leftContract = contracts[1];
                }

                try
                {
                    var existingMessages = await Http.GetFromJsonAsync<List<ChatMessageDto>>($"/api/chatmessages/session/{sessionId}");
                    if (existingMessages != null && existingMessages.Any())
                    {
                        messages = new List<Message>();
                        foreach (var m in existingMessages)
                        {
                            if (!string.IsNullOrWhiteSpace(m.Message))
                            {
                                messages.Add(new Message { Text = m.Message, IsUser = true });
                            }
                            if (!string.IsNullOrWhiteSpace(m.Response))
                            {
                                messages.Add(new Message
                                {
                                    Text = m.Response,
                                    IsUser = false,
                                    Sources = m.Sources ?? new List<ChatMessageSourceDto>()
                                });
                            }
                        }
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"No existing messages: {ex.Message}");
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading comparison session: {ex.Message}");
            ToastService.Notify(new(ToastType.Danger, "Failed to load comparison session"));
        }
    }

    private async Task OnInput(ChangeEventArgs e)
    {
        newMessage = e.Value?.ToString() ?? "";
        await JS.InvokeVoidAsync("autoResizeTextarea");
    }

    private async Task OnKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !e.ShiftKey)
        {
            await JS.InvokeVoidAsync("eval", "event.preventDefault()");
            await SendMessage();
        }
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(newMessage) || isLoading) return;

        var userInput = newMessage.Trim();
        newMessage = "";

        messages.Add(new Message { Text = userInput, IsUser = true });
        isLoading = true;
        StateHasChanged();

        await JS.InvokeVoidAsync("resetTextareaHeight");
        await JS.InvokeVoidAsync("scrollChatToBottom");

        try
        {
            var request = new CreateChatMessageDto
            {
                SessionId = sessionId,
                Message = userInput
            };

            var response = await Http.PostAsJsonAsync("/api/chatmessages", request);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<ChatMessageDto>();

                if (result != null)
                {
                    messages.Add(new Message
                    {
                        Text = result.Response ?? "Empty response",
                        IsUser = false,
                        Sources = result.Sources ?? new List<ChatMessageSourceDto>()
                    });

                    Console.WriteLine($"Received AI response with {result.Sources?.Count ?? 0} sources");
                }
            }
            else
            {
                messages.Add(new Message
                {
                    Text = $"Error: {response.StatusCode}. Please try again.",
                    IsUser = false
                });
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Exception: {ex.Message}");
            messages.Add(new Message
            {
                Text = "An unexpected error occurred. Please try again.",
                IsUser = false
            });
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
            await JS.InvokeVoidAsync("scrollChatToBottom");
        }
    }

    private async Task JumpToComparisonSource(List<ChatMessageSourceDto> sources, int index)
    {
        if (sources == null || sources.Count == 0)
        {
            Console.WriteLine("No sources available");
            return;
        }

        if (index < 0 || index >= sources.Count)
        {
            Console.WriteLine($"Invalid index {index} for {sources.Count} sources");
            return;
        }

        var source = sources[index];

        try
        {
            string viewerId = "leftPdfViewer";

            if (source.ContractId == leftContract?.Id)
            {
                viewerId = "leftPdfViewer";
                Console.WriteLine($"Source is from LEFT contract (ID: {source.ContractId})");
            }
            else if (source.ContractId == rightContract?.Id)
            {
                viewerId = "rightPdfViewer";
                Console.WriteLine($"Source is from RIGHT contract (ID: {source.ContractId})");
            }
            else
            {
                Console.WriteLine($"Warning: Source contract ID {source.ContractId} doesn't match left ({leftContract?.Id}) or right ({rightContract?.Id})");
            }

            Console.WriteLine($"=== Jumping to source {index + 1} in {viewerId} ===");
            Console.WriteLine($"Page: {source.PageNumber}");
            Console.WriteLine($"Similarity Score: {source.SimilarityScore:F3}");

            await JS.InvokeVoidAsync("pdfViewerClearHighlights", "leftPdfViewer");
            await JS.InvokeVoidAsync("pdfViewerClearHighlights", "rightPdfViewer");
            await Task.Delay(100);

            Console.WriteLine($"Navigating to page {source.PageNumber} in {viewerId}...");
            await JS.InvokeVoidAsync("pdfViewerGoToPage", source.PageNumber, viewerId);
            await Task.Delay(3000);

            var textToHighlight = !string.IsNullOrWhiteSpace(source.ChunkText)
                ? source.ChunkText
                : source.OriginalChunkText;

            if (string.IsNullOrWhiteSpace(textToHighlight))
            {
                Console.WriteLine("No text available for highlighting");
                return;
            }

            var searchPhrase = ExtractBestSearchPhrase(textToHighlight);

            Console.WriteLine($"Text to highlight (first 100 chars): '{textToHighlight.Substring(0, Math.Min(100, textToHighlight.Length))}...'");
            Console.WriteLine($"Search phrase (first 60 chars): '{searchPhrase.Substring(0, Math.Min(60, searchPhrase.Length))}...'");

            await JS.InvokeVoidAsync("pdfViewerHighlightText", searchPhrase, viewerId);

            Console.WriteLine($"✓ Highlighting complete in {viewerId}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error jumping to comparison source: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
        }
    }

    private string ExtractBestSearchPhrase(string chunkText)
    {
        if (string.IsNullOrWhiteSpace(chunkText))
            return "";

        chunkText = System.Text.RegularExpressions.Regex.Replace(chunkText, @"\s+", " ").Trim();

        // If starts with lowercase, skip first word (it's cut off)
        if (chunkText.Length > 0 && char.IsLower(chunkText[0]))
        {
            var firstSpaceIndex = chunkText.IndexOf(' ');
            if (firstSpaceIndex > 0 && firstSpaceIndex < chunkText.Length - 1)
            {
                chunkText = chunkText.Substring(firstSpaceIndex + 1).Trim();
                Console.WriteLine($"Skipped incomplete first word");
            }
        }

        // Use 100 characters for better matching
        var searchLength = Math.Min(100, chunkText.Length);
        var searchPhrase = chunkText.Substring(0, searchLength);

        Console.WriteLine($"Search phrase: {searchPhrase.Length} chars, starts with: '{searchPhrase.Substring(0, Math.Min(50, searchPhrase.Length))}'");

        return searchPhrase;
    }

    private void StartResize(MouseEventArgs e)
    {
        JS.InvokeVoidAsync("startCompareChatResizing", e.ClientX);
    }

    private void StartSidebarResize(MouseEventArgs e)
    {
        JS.InvokeVoidAsync("startSidebarResizing", e.ClientX);
    }

    private string CleanFileName(string fileName)
    {
        var index = fileName.IndexOf('_');
        var cleaned = index >= 0 ? fileName[(index + 1)..] : fileName;

        var dot = cleaned.LastIndexOf('.');
        if (dot > 0)
        {
            cleaned = cleaned[..dot];
        }
        return cleaned;
    }

    private string GetComparisonTitle()
    {
        return "Contract Comparison";
    }

    public class Message
    {
        public string Text { get; set; } = "";
        public bool IsUser { get; set; }
        public List<ChatMessageSourceDto> Sources { get; set; } = new();
    }

    public class ChatSessionDto
    {
        public int Id { get; set; }
        public List<int> ContractIds { get; set; } = new();
    }

    public class ChatMessageDto
    {
        public int Id { get; set; }
        public int SessionId { get; set; }
        public string Message { get; set; } = "";
        public string Response { get; set; } = "";
        public DateTime CreatedAt { get; set; }
        public List<ChatMessageSourceDto> Sources { get; set; } = new();
    }

    public class CreateChatMessageDto
    {
        public int SessionId { get; set; }
        public string Message { get; set; } = "";
    }

    public class ChatMessageSourceDto
    {
        public int ContractId { get; set; }
        public string ChunkText { get; set; } = "";
        public string OriginalChunkText { get; set; } = "";
        public int ChunkIndex { get; set; }
        public int PageNumber { get; set; }
        public double SimilarityScore { get; set; }
    }
}