@page "/contract/{id:int}"
@using NorthOaks.Shared.Model.Contracts
@inject HttpClient Http
@inject IJSRuntime JS

<div class="viewer-wrapper">
    <div class="pdf-area">
        @if (contract == null)
        {
            <div class="text-muted m-3">Loading contract...</div>
        }
        else
        {
            <PdfViewer Class="pdf-frame"
                       Url="@contract.FileUrl"
                       OnDocumentLoaded="OnDocumentLoaded"
                       OnPageChanged="OnPageChanged" />
        }
    </div>

    <div class="resizer" @onmousedown="StartResize"></div>

    <div id="chatPanel" class="chat-panel">
        <div class="chat-header">
            <h5>💬 Chat about this contract</h5>
        </div>

        <div id="chatMessages" class="chat-messages">
            @if (messages.Count == 0)
            {
                <div class="text-muted">No messages yet. Start chatting!</div>
            }
            else
            {
                @foreach (var msg in messages)
                {
                    <div class="message @(msg.IsUser ? "user-message" : "ai-message")">
                        <strong>@(msg.IsUser ? "You" : "AI"):</strong> @msg.Text
                    </div>
                }
            }
        </div>

        <div class="chat-input">
            <div class="input-wrapper">
                <input class="form-control chat-input-field"
                       @bind="newMessage"
                       @bind:event="oninput"
                       placeholder="Type a message..."
                       @onkeypress="OnKeyPress" />
                <button class="send-btn-inside"
                        @onclick="SendMessage"
                        @onclick:preventDefault="true"
                        disabled="@string.IsNullOrWhiteSpace(newMessage)">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22,2 15,22 11,13 2,9"></polygon>
                    </svg>
                </button>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter] public int id { get; set; }
    private ContractReadDto? contract;
    private List<Message> messages = new();
    private string newMessage = "";

    protected override async Task OnInitializedAsync()
    {
        contract = await Http.GetFromJsonAsync<ContractReadDto>($"/api/contracts/{id}");
    }

    private void OnDocumentLoaded(PdfViewerEventArgs args) { }
    private void OnPageChanged(PdfViewerEventArgs args) { }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(newMessage)) return;

        messages.Add(new Message { Text = newMessage.Trim(), IsUser = true });
        messages.Add(new Message { Text = $"Got your message: {newMessage.Trim()}", IsUser = false });
        newMessage = "";

        await JS.InvokeVoidAsync("scrollChatToBottom");
    }

    private void OnKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            _ = SendMessage();
        }
    }

    private void StartResize(MouseEventArgs e)
    {
        JS.InvokeVoidAsync("startResizing");
    }

    public class Message
    {
        public string Text { get; set; } = "";
        public bool IsUser { get; set; }
    }
}
