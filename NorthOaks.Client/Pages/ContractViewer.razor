@page "/contract/{id:int}"
@using NorthOaks.Shared.Model.Contracts
@using NorthOaks.Shared.Model.Chat
@inject HttpClient Http
@inject IJSRuntime JS

<div class="contract-viewer-page">
    <div class="viewer-wrapper">
        <div class="pdf-area">
            @if (contract == null)
            {
                <div class="text-muted m-3">Loading contract...</div>
            }
            else
            {
                <PdfViewer Class="pdf-frame"
                           Url="@contract.FileUrl"
                           OnDocumentLoaded="OnDocumentLoaded"
                           OnPageChanged="OnPageChanged" />
            }
        </div>

        <div class="resizer" @onmousedown="StartResize"></div>

        <div id="chatPanel" class="chat-panel">
            <div class="chat-header">
                <h5> Chat about this contract</h5>
            </div>

            <div id="chatMessages" class="chat-messages">
                @if (messages.Count == 0)
                {
                    <div class="text-muted empty-chat">No messages yet. Start chatting!</div>
                }
                else
                {
                    @foreach (var msg in messages)
                    {
                        <div class="message @(msg.IsUser ? "user-message" : "ai-message")">
                            <strong>@(msg.IsUser ? "You" : "AI"):</strong> @msg.Text
                        </div>
                    }
                }

                @if (isLoading)
                {
                    <div class="message ai-message loading-message">
                        <div class="loading-indicator">
                            <div class="loading-dots">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                        </div>
                    </div>
                }
            </div>

            <div class="chat-input">
                <div class="input-wrapper">
                    <textarea class="chat-input-field"
                              value="@newMessage"
                              @oninput="OnInput"
                              placeholder="Type a message..."
                              @onkeydown="OnKeyDown"
                              rows="1"></textarea>

                    <button class="send-btn-inside"
                            @onclick="SendMessage"
                            @onclick:preventDefault="true"
                            disabled="@string.IsNullOrWhiteSpace(newMessage)">
                        <svg width="16" height="16" viewBox="0 0 24 24"
                             fill="none" stroke="currentColor"
                             stroke-width="2" stroke-linecap="round"
                             stroke-linejoin="round">
                            <line x1="22" y1="2" x2="11" y2="13" />
                            <polygon points="22,2 15,22 11,13 2,9" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter] public int id { get; set; }
    private ContractReadDto? contract;
    private List<Message> messages = new();
    private string newMessage = "";
    private int currentSessionId;
    private bool isLoading = false;

    protected override async Task OnInitializedAsync()
    {
        contract = await Http.GetFromJsonAsync<ContractReadDto>($"/api/contracts/{id}");

        var sessionResponse = await Http.PostAsJsonAsync("/api/chatsessions",
            new CreateChatSessionDto { ContractIds = new List<int> { id } });

        if (sessionResponse.IsSuccessStatusCode)
        {
            var session = await sessionResponse.Content.ReadFromJsonAsync<ChatSessionDto>();
            if (session != null)
                currentSessionId = session.Id;
        }
    }

    private void OnDocumentLoaded(PdfViewerEventArgs args) { }
    private void OnPageChanged(PdfViewerEventArgs args) { }

    private async Task OnInput(ChangeEventArgs e)
    {
        newMessage = e.Value?.ToString() ?? "";
        await JS.InvokeVoidAsync("autoResizeTextarea");
        await InvokeAsync(StateHasChanged);
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(newMessage)) return;

        var userInput = newMessage.Trim();
        newMessage = "";

        messages.Add(new Message { Text = userInput, IsUser = true });
        isLoading = true;
        await InvokeAsync(StateHasChanged);
        await JS.InvokeVoidAsync("resetTextareaHeight");
        await JS.InvokeVoidAsync("scrollChatToBottom");

        try
        {
            var request = new CreateChatMessageDto { SessionId = currentSessionId, Message = userInput };
            var response = await Http.PostAsJsonAsync("/api/chatmessages", request);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<ChatMessageDto>();
                messages.Add(new Message { Text = result?.Response ?? "Empty response", IsUser = false });
            }
            else
            {
                messages.Add(new Message { Text = $"Backend error: {response.StatusCode}", IsUser = false });
            }
        }
        catch (Exception ex)
        {
            messages.Add(new Message { Text = $"Exception: {ex.Message}", IsUser = false });
        }
        finally
        {
            isLoading = false;
            await InvokeAsync(StateHasChanged);
            await JS.InvokeVoidAsync("scrollChatToBottom");
        }
    }

    private async Task OnKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !e.ShiftKey)
        {
            await JS.InvokeVoidAsync("eval", "event.preventDefault()");
            await SendMessage();
        }
    }

    private void StartResize(MouseEventArgs e)
    {
        JS.InvokeVoidAsync("startResizing");
    }

    public class Message
    {
        public string Text { get; set; } = "";
        public bool IsUser { get; set; }
    }
}
