@page "/contract/{id:int}"
@using NorthOaks.Shared.Model.Contracts
@inject HttpClient Http

<div class="container-fluid py-4 px-5 bg-light" style="min-height:100vh;">
    <div class="row gx-4" style="height: calc(100vh - 120px);">

        <!-- PDF Viewer Area -->
        <div class="col-lg-8 d-flex flex-column bg-white rounded shadow-sm p-3">
            @if (contract == null)
            {
                <div class="text-center my-auto text-muted">Loading contract...</div>
            }
            else
            {
                <h4 class="mb-3 text-truncate">@CleanFileName(contract.FileName)</h4>

                <PdfViewer Class="flex-grow-1 border rounded"
                           Style="width:100%; min-height:0; height:100%;"
                           Url="@contract.FileUrl"
                           OnDocumentLoaded="OnDocumentLoaded"
                           OnPageChanged="OnPageChanged" />
            }
        </div>

        <!-- Chat Sidebar -->
        <div class="col-lg-4 d-flex flex-column">
            <div class="bg-white rounded shadow-sm p-3 flex-grow-1 d-flex flex-column">
                <h5 class="mb-3">💬 Chat about this contract</h5>

                <div class="flex-grow-1 border rounded p-2 mb-2 overflow-auto bg-light" style="min-height:0;">
                    @foreach (var msg in messages)
                    {
                        <div class="mb-1">
                            <strong>@msg.User:</strong> @msg.Text
                        </div>
                    }
                </div>

                <div class="mt-auto">
                    <input class="form-control mb-2" @bind="newMessage" placeholder="Type a message..." />
                    <button class="btn btn-primary w-100" @onclick="SendMessage">Send</button>
                </div>
            </div>
        </div>

    </div>
</div>

@code {
    [Parameter] public int id { get; set; }
    private ContractReadDto? contract;
    private List<Message> messages = new();
    private string newMessage = "";
    private string eventLog = "";
   

    protected override async Task OnInitializedAsync()
    {
        contract = await Http.GetFromJsonAsync<ContractReadDto>($"/api/contracts/{id}");
    }

    private string CleanFileName(string fileName)
    {
        var i = fileName.IndexOf('_');
        return (i >= 0 && i < fileName.Length - 1) ? fileName[(i + 1)..] : fileName;
    }

    private void OnDocumentLoaded(PdfViewerEventArgs args)
        => eventLog = $"Loaded {args.TotalPages} pages";

    private void OnPageChanged(PdfViewerEventArgs args)
        => eventLog = $"Page {args.CurrentPage} of {args.TotalPages}";

    private void SendMessage()
    {
        if (!string.IsNullOrWhiteSpace(newMessage))
        {
            messages.Add(new Message { User = "You", Text = newMessage });
            newMessage = string.Empty;
        }
    }

    public class Message
    {
        public string User { get; set; } = "";
        public string Text { get; set; } = "";
    }
}
