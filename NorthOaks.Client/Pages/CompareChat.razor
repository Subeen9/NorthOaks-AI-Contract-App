@page "/compare-chat/{sessionId:int}"
@using NorthOaks.Shared.Model.Contracts
@using NorthOaks.Shared.Model.Chat
@using System.Net.Http.Json
@inject HttpClient Http
@inject IJSRuntime JS
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]

<div class="contract-viewer-page">
    <div class="content">
        <div class="viewer-wrapper">
            <div class="pdf-area" style="background: #f8f9fa; display: flex; align-items: center; justify-content: center; flex-direction: column;">
                @if (contracts.Count == 0)
                {
                    <div class="text-center text-muted">
                        <i class="bi bi-files" style="font-size: 4rem;"></i>
                        <p class="mt-3">Loading contracts...</p>
                    </div>
                }
                else
                {
                    <div class="text-center" style="max-width: 500px;">
                        <h4 class="mb-4" style="color: var(--brand-blue);">
                            <i class="bi bi-files"></i> Comparing @contracts.Count Contracts
                        </h4>
                        <div class="list-group">
                            @foreach (var contract in contracts)
                            {
                                <div class="list-group-item d-flex align-items-center gap-3">
                                    <i class="bi bi-file-earmark-pdf text-danger" style="font-size: 1.5rem;"></i>
                                    <div class="text-start">
                                        <div class="fw-semibold">@CleanFileName(contract.FileName)</div>
                                        <small class="text-muted">Uploaded: @contract.UploadDate.ToShortDateString()</small>
                                    </div>
                                </div>
                            }
                        </div>
                        <div class="alert alert-info mt-4 text-start">
                            <i class="bi bi-lightbulb"></i> <strong>Try asking:</strong>
                            <ul class="mb-0 mt-2" style="font-size: 0.9rem;">
                                <li>What are the main differences?</li>
                                <li>Compare the payment terms</li>
                                <li>Which contract is better for vendors?</li>
                                <li>What clauses are missing in contract 2?</li>
                            </ul>
                        </div>
                    </div>
                }
            </div>

            <div class="resizer" @onmousedown="StartResize"></div>

            <div id="chatPanel" class="chat-panel">
                <div class="chat-header">
                    <h5>Contract Comparison Chat</h5>
                </div>

                <div id="chatMessages" class="chat-messages">
                    @if (messages.Count == 0)
                    {
                        <div class="text-muted empty-chat">Ask questions to compare the selected contracts!</div>
                    }
                    else
                    {
                        @foreach (var msg in messages)
                        {
                            <div class="message @(msg.IsUser ? "user-message" : "ai-message")">
                                <strong>@(msg.IsUser ? "You" : "AI"):</strong>
                                <div class="message-content">@msg.Text</div>
                            </div>
                        }
                    }

                    @if (isLoading)
                    {
                        <div class="message ai-message loading-message">
                            <div class="loading-indicator">
                                <div class="loading-dots">
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                </div>
                            </div>
                        </div>
                    }
                </div>

                <div class="chat-input">
                    <div class="input-wrapper">
                        <textarea class="chat-input-field"
                                  value="@newMessage"
                                  @oninput="OnInput"
                                  placeholder="Ask about differences between contracts..."
                                  @onkeydown="OnKeyDown"
                                  rows="1"></textarea>

                        <button class="send-btn-inside"
                                @onclick="SendMessage"
                                @onclick:preventDefault="true"
                                disabled="@(string.IsNullOrWhiteSpace(newMessage) || isLoading)">
                            <svg width="16" height="16" viewBox="0 0 24 24"
                                 fill="none" stroke="currentColor"
                                 stroke-width="2" stroke-linecap="round"
                                 stroke-linejoin="round">
                                <line x1="22" y1="2" x2="11" y2="13" />
                                <polygon points="22,2 15,22 11,13 2,9" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public int sessionId { get; set; }

    [Inject] protected ToastService ToastService { get; set; } = default!;

    private List<ContractReadDto> contracts = new();
    private List<Message> messages = new();
    private string newMessage = "";
    private bool isLoading = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var session = await Http.GetFromJsonAsync<ChatSessionDto>($"/api/chatsessions/{sessionId}");

            if (session != null && session.ContractIds != null)
            {
                foreach (var contractId in session.ContractIds)
                {
                    var contract = await Http.GetFromJsonAsync<ContractReadDto>($"/api/contracts/{contractId}");
                    if (contract != null)
                    {
                        contracts.Add(contract);
                    }
                }

                var existingMessages = await Http.GetFromJsonAsync<List<ChatMessageDto>>($"/api/chatmessages/session/{sessionId}");
                if (existingMessages != null && existingMessages.Any())
                {
                    messages = new List<Message>();
                    foreach (var m in existingMessages)
                    {
                        if (!string.IsNullOrWhiteSpace(m.Message))
                        {
                            messages.Add(new Message { Text = m.Message, IsUser = true });
                        }
                        if (!string.IsNullOrWhiteSpace(m.Response))
                        {
                            messages.Add(new Message { Text = m.Response, IsUser = false });
                        }
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading comparison session: {ex.Message}");
            ToastService.Notify(new(ToastType.Danger, "Failed to load comparison session"));
        }
    }

    private async Task OnInput(ChangeEventArgs e)
    {
        newMessage = e.Value?.ToString() ?? "";
        await JS.InvokeVoidAsync("autoResizeTextarea");
    }

    private async Task OnKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !e.ShiftKey)
        {
            await JS.InvokeVoidAsync("eval", "event.preventDefault()");
            await SendMessage();
        }
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(newMessage) || isLoading) return;

        var userInput = newMessage.Trim();
        newMessage = "";

        messages.Add(new Message { Text = userInput, IsUser = true });
        isLoading = true;
        StateHasChanged();

        await JS.InvokeVoidAsync("resetTextareaHeight");
        await JS.InvokeVoidAsync("scrollChatToBottom");

        try
        {
            var request = new CreateChatMessageDto
            {
                SessionId = sessionId,
                Message = userInput
            };

            var response = await Http.PostAsJsonAsync("/api/chatmessages", request);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<ChatMessageDto>();

                if (result != null)
                {
                    messages.Add(new Message
                    {
                        Text = result.Response ?? "Empty response",
                        IsUser = false
                    });
                }
            }
            else
            {
                messages.Add(new Message
                {
                    Text = $"Error: {response.StatusCode}. Please try again.",
                    IsUser = false
                });
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Exception: {ex.Message}");
            messages.Add(new Message
            {
                Text = "An unexpected error occurred. Please try again.",
                IsUser = false
            });
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
            await JS.InvokeVoidAsync("scrollChatToBottom");
        }
    }

    private void StartResize(MouseEventArgs e)
    {
        JS.InvokeVoidAsync("startResizing");
    }

    private string CleanFileName(string fileName)
    {
        var index = fileName.IndexOf('_');
        return index >= 0 ? fileName.Substring(index + 1) : fileName;
    }

    public class Message
    {
        public string Text { get; set; } = "";
        public bool IsUser { get; set; }
    }

    public class ChatSessionDto
    {
        public int Id { get; set; }
        public List<int> ContractIds { get; set; } = new();
    }
}