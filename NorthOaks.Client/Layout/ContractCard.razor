@inject NavigationManager Navigation
@inject HttpClient Http

<div class="card shadow-sm mb-3 h-100 contract-hover position-relative @(IsSelected ? "selected-for-comparison" : "")"
     style="border-radius:14px; overflow:hidden; @(IsSelected ? "background: var(--brand-gold) !important;" : "")"
     @ondblclick="@(() => Navigation.NavigateTo($"/contract/{Id}"))">

    <!-- Options dropdown - ONLY SHOW IF OWNER -->
    @if (IsOwner)
    {
        <div class="dropdown position-absolute top-0 end-0 m-2">
            <button class="btn btn-sm btn-light p-1" type="button" id="dropdownMenuButton-@Id"
                    data-bs-toggle="dropdown" aria-expanded="false" @onclick:stopPropagation="true">
                <i class="bi bi-three-dots-vertical" style="color:black"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end shadow-sm"
                aria-labelledby="dropdownMenuButton-@Id"
                style="border-radius: 8px; font-size: 0.9rem;">
                <li>
                    <button class="dropdown-item text-danger"
                            @onclick:stopPropagation="true"
                            @onclick="OpenDelete">
                        <i class="bi bi-trash me-2"></i> Delete Contract
                    </button>
                </li>
                <li>
                    <button class="dropdown-item"
                            @onclick:stopPropagation="true"
                            @onclick="ToggleVisibility">
                        <i class="bi @(IsPublic ? "bi-lock-fill" : "bi-globe-americas") me-2"></i>
                        @(IsPublic ? "Make Private" : "Make Public")
                    </button>
                </li>
            </ul>
        </div>
    }

    <!-- Pin button -->
    <button type="button"
            class="pin-btn @(IsPinned ? "pinned" : null)"
            aria-pressed="@(IsPinned ? "true" : "false")"
            title="@(IsPinned ? "Unpin" : "Pin")"
            @onclick:stopPropagation="true"
            @onclick="OnTogglePin">
        <i class="bi @(IsPinned ? "bi-pin-angle-fill" : "bi-pin-angle")"></i>
    </button>

    <!-- Visibility Badge -->
    <div class="position-absolute top-0 start-0 m-2">
        <span class="visibility-badge @(IsPublic ? "public" : "private")">
            <i class="bi @(IsPublic ? "bi-globe-americas" : "bi-lock-fill") me-1"></i>
            @(IsPublic ? "Public" : "Private")
        </span>
    </div>

    <!-- Card content -->
    <div class="card-body d-flex flex-column" style="padding: 48px 22px 60px 22px !important; @(IsSelected ? "color:#fff !important;" : "")">
        <h5 class="card-title fw-bold contract-title text-truncate"
            style="@(IsSelected ? "color:#fff !important;" : "")">
            @FileDisplayName
        </h5>

        @if (Type == CardType.Contract)
        {
            <p class="@(IsSelected ? "text-white" : "text-muted") mb-1">
                Uploaded by <strong>@UploadedBy</strong>
            </p>

            <small class="@(IsSelected ? "text-white" : "text-muted")">
                Uploaded: @UploadDate.ToShortDateString()
            </small>
        }
        else if (Type == CardType.Comparison)
        {
            <p class="@(IsSelected ? "text-white" : "text-muted") mb-1">
                Created: <strong>@UploadDate.ToShortDateString()</strong>
            </p>

            <small class="@(IsSelected ? "text-white" : "text-muted")">
                @MessageCount message@(MessageCount == 1 ? "" : "s")
            </small>
        }
    </div>
</div>

@code {
    [Parameter] public int Id { get; set; }
    [Parameter] public string FileName { get; set; } = default!;
    [Parameter] public int UserId { get; set; }
    [Parameter] public string? UploadedBy { get; set; }
    [Parameter] public DateTime UploadDate { get; set; }
    [Parameter] public bool IsSelected { get; set; }
    [Parameter] public bool IsPublic { get; set; }
    [Parameter] public bool IsPinned { get; set; }
    public enum CardType { Contract, Comparison }
    private string FileDisplayName => System.IO.Path.GetFileNameWithoutExtension(FileName);


    [Parameter] public CardType Type { get; set; } = CardType.Contract;

    [Parameter] public string? ComparisonTitle { get; set; }
    [Parameter] public int? MessageCount { get; set; }

    [Parameter] public EventCallback<int> OnDelete { get; set; }
    [Parameter] public EventCallback<int> OnToggleVisibility { get; set; }
    [Parameter] public EventCallback OnTogglePin { get; set; }

    private static int? _currentUserId = null;
    private bool IsOwner => _currentUserId.HasValue && UserId == _currentUserId.Value;

    protected override async Task OnInitializedAsync()
    {
        // Only fetch once per session (static field caches it)
        if (_currentUserId == null)
        {
            try
            {
                var response = await Http.GetFromJsonAsync<UserDto>("/api/users/me");
                if (response != null)
                {
                    _currentUserId = response.Id;
                    Console.WriteLine($"✓ Current User ID: {_currentUserId}");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error getting current user: {ex.Message}");
            }
        }

        Console.WriteLine($"Contract {Id}: Owner={UserId}, Current={_currentUserId}, IsOwner={IsOwner}");
    }

    private async Task OpenDelete()
    {
        if (OnDelete.HasDelegate)
            await OnDelete.InvokeAsync(Id);
    }

    private async Task ToggleVisibility()
    {
        if (OnToggleVisibility.HasDelegate)
            await OnToggleVisibility.InvokeAsync(Id);
    }

    public class UserDto
    {
        public int Id { get; set; }
        public string UserName { get; set; } = string.Empty;
        public string FirstName { get; set; } = string.Empty;
        public string LastName { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
    }
}